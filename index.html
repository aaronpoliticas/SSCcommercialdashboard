<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Comercial</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF para generar reportes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        
        .tab-active { background-color: #1e3a8a; color: white; border: 2px solid #1e3a8a; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .tab-inactive { background-color: white; color: #64748b; border: 2px solid #cbd5e1; }
        .tab-inactive:hover { background-color: #f1f5f9; color: #334155; border-color: #94a3b8; }

        .metric-btn.active { background-color: #0f172a; color: white; font-weight: bold; border-color: #0f172a; }
        .metric-btn { background-color: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; transition: all 0.2s; }
        
        .lang-btn { opacity: 0.6; filter: grayscale(100%); transition: all 0.2s; }
        .lang-btn.active { opacity: 1; filter: grayscale(0%); transform: scale(1.1); font-weight: bold; text-decoration: underline; text-decoration-color: #2563eb; text-underline-offset: 4px; }
        
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans text-slate-800 overflow-hidden">

    <!-- MODAL DE FACTURAS -->
    <div id="invoice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span id="modal-title">Facturas</span>
                    </h3>
                    <p id="modal-subtitle" class="text-xs text-slate-500 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar p-0">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 sticky top-0 border-b border-slate-200 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-semibold" data-i18n="th_invoice"># Factura</th>
                            <th class="px-6 py-3 font-semibold text-right" data-i18n="th_amount">Monto</th>
                        </tr>
                    </thead>
                    <tbody id="modal-tbody" class="divide-y divide-slate-100 text-slate-700"></tbody>
                </table>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-xl flex justify-between items-center">
                <span class="text-xs text-slate-500" id="modal-count"></span>
                <span class="text-sm font-bold text-slate-800" id="modal-total"></span>
            </div>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div id="status-bar" class="hidden px-4 py-2 text-xs font-medium flex justify-between items-center border-b shadow-sm z-40 bg-white">
        <span id="status-text" class="flex items-center gap-2"></span>
        <button onclick="window.location.reload()" class="underline ml-4">Recargar</button>
    </div>

    <div class="flex flex-1 overflow-hidden relative" id="main-container">
        
        <!-- PANEL IZQUIERDO -->
        <div id="left-panel" class="w-full md:w-5/12 lg:w-1/3 bg-white border-r border-slate-200 flex flex-col shadow-xl z-20 absolute inset-0 md:relative transition-transform duration-300">
            <div class="bg-slate-50 border-b border-slate-200 p-4 pb-2">
                <div class="flex justify-between items-start mb-3">
                    <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2 max-w-[65%] leading-tight" data-i18n="dashboard_title">
                        <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Dashboard
                    </h2>
                    <div class="flex gap-2 bg-white px-2 py-1 rounded-full border border-slate-200 shadow-sm flex-shrink-0">
                        <button onclick="changeLanguage('es')" id="lang-es" class="lang-btn active text-xs flex items-center gap-1"><span>MX</span> ðŸ‡²ðŸ‡½</button>
                        <div class="w-px bg-slate-200 h-4 self-center"></div>
                        <button onclick="changeLanguage('fr')" id="lang-fr" class="lang-btn text-xs flex items-center gap-1"><span>FR</span> ðŸ‡«ðŸ‡·</button>
                    </div>
                </div>

                <div class="flex bg-slate-200 p-1 rounded-lg mb-3 shadow-inner">
                    <button onclick="changeMetric('weight')" id="metric-weight" class="metric-btn active flex-1 py-1.5 rounded-md text-xs flex items-center justify-center gap-1.5 shadow-sm">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                        <span data-i18n="metric_kg">Consumo (KG)</span>
                    </button>
                    <button onclick="changeMetric('money')" id="metric-money" class="metric-btn flex-1 py-1.5 rounded-md text-xs flex items-center justify-center gap-1.5">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span data-i18n="metric_money">FacturaciÃ³n ($)</span>
                    </button>
                </div>
                
                <div class="flex gap-2 mb-3">
                    <button onclick="changeView('february')" id="tab-february" class="flex-1 py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-active touch-manipulation">
                        <span data-i18n="tab_feb">Solo Febrero</span><br/><span class="font-normal opacity-80 text-[10px] md:text-[9px]" data-i18n="tab_feb_sub">(Comparativo Mes)</span>
                    </button>
                    <button onclick="changeView('bimester')" id="tab-bimester" class="flex-1 py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-inactive touch-manipulation">
                        <span data-i18n="tab_bimester">1er Bimestre</span><br/><span class="font-normal opacity-80 text-[10px] md:text-[9px]" data-i18n="tab_bimester_sub">(Ene + Feb)</span>
                    </button>
                </div>

                <div class="relative mt-2">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                    <input type="text" id="search-input" placeholder="Buscar cliente..." class="w-full pl-9 pr-3 py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white transition-all shadow-sm">
                </div>

                <div class="mt-2 px-1">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <input type="checkbox" id="hide-small-check" class="form-checkbox h-3.5 w-3.5 text-blue-600 rounded border-slate-300 focus:ring-blue-500 transition-colors" checked onchange="toggleHideSmall(this.checked)">
                        <span class="text-xs text-slate-500 group-hover:text-slate-700 transition-colors select-none" data-i18n="hide_small_label">Ocultar clientes con consumos pequeÃ±os</span>
                    </label>
                </div>
            </div>

            <div class="grid grid-cols-12 px-4 py-3 bg-slate-100 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase tracking-wider sticky top-0 z-10">
                <div class="col-span-6 pl-1" data-i18n="col_client">Cliente</div>
                <div class="col-span-3 text-right header-year-2025">2025</div>
                <div class="col-span-3 text-right header-year-2026">2026</div>
            </div>
            <div id="clients-list" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 relative">
                <div id="list-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10">
                    <svg class="animate-spin h-10 w-10 text-blue-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-xs text-slate-500 animate-pulse" data-i18n="loading">Cargando datos...</span>
                </div>
            </div>
            <div id="list-footer" class="p-3 bg-slate-50 border-t border-slate-200 text-[10px] text-slate-400 text-center font-medium">0 Clientes listados</div>
        </div>

        <!-- PANEL DERECHO (DETALLE) -->
        <div id="detail-panel" class="w-full md:w-7/12 lg:w-2/3 flex flex-col h-full bg-slate-100 overflow-y-auto p-4 md:p-6 gap-6 custom-scrollbar absolute inset-0 md:relative z-30 hidden md:flex">
            <button onclick="backToMobileList()" class="md:hidden flex items-center gap-2 text-slate-500 hover:text-blue-600 font-medium mb-2 w-fit">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span data-i18n="back_list">Volver a la lista</span>
            </button>

            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-slate-400">
                <svg class="w-20 h-20 mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <p data-i18n="empty_state">Selecciona un cliente para ver su desglose</p>
            </div>
            
            <div id="detail-content" class="hidden flex-col gap-6 animate-fade-in pb-8">
                <div class="flex flex-col border-b border-slate-200 pb-4">
                    <div class="flex justify-between items-start">
                        <h1 id="detail-title" class="text-xl md:text-3xl font-bold text-slate-800 break-words leading-tight"></h1>
                        <!-- BOTÃ“N PDF -->
                        <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-2 px-3 rounded shadow-md flex items-center gap-1 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            PDF
                        </button>
                    </div>
                    <p id="detail-subtitle" class="text-sm text-slate-500 mt-1"></p>
                </div>

                <!-- Tabla 2026 -->
                <div class="bg-white rounded-xl shadow-sm border border-blue-200 ring-2 ring-blue-50 overflow-hidden">
                    <div class="bg-blue-50 px-4 md:px-6 py-3 border-b border-blue-100 flex flex-wrap justify-between items-center sticky top-0 z-20 gap-2">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-blue-900 text-sm"><span id="header-2026">2026</span></h3>
                            <button onclick="openInvoiceModal(2026)" class="text-[10px] bg-white border border-blue-300 hover:bg-blue-50 text-blue-700 px-2 py-1 rounded shadow-sm flex items-center transition-colors active:scale-95">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span data-i18n="btn_invoices">Ver Facturas</span>
                            </button>
                        </div>
                        <div id="total-2026"></div>
                    </div>
                    <div class="overflow-auto max-h-[350px] custom-scrollbar">
                        <table class="w-full text-left text-sm relative">
                            <thead class="bg-white text-xs uppercase text-slate-500 border-b border-blue-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 md:px-6 py-3 w-5/12 bg-white" data-i18n="col_prod">Producto</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-ene hidden md:table-cell" data-i18n="col_jan">Enero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-feb hidden md:table-cell" data-i18n="col_feb">Febrero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-blue-50/50 font-bold text-blue-800" data-i18n="col_sum_2026">Total 2026</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white font-bold w-16 md:w-24" data-i18n="col_growth">% Crec.</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-2026" class="divide-y divide-blue-50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabla 2025 -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 md:px-6 py-3 border-b border-slate-200 flex flex-wrap justify-between items-center sticky top-0 z-20 gap-2">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-slate-700 text-sm"><span id="header-2025">2025</span></h3>
                            <button onclick="openInvoiceModal(2025)" class="text-[10px] bg-white border border-slate-300 hover:bg-slate-100 text-slate-600 px-2 py-1 rounded shadow-sm flex items-center transition-colors active:scale-95">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span data-i18n="btn_invoices">Ver Facturas</span>
                            </button>
                        </div>
                        <div id="total-2025"></div>
                    </div>
                    <div class="overflow-auto max-h-[350px] custom-scrollbar">
                        <table class="w-full text-left text-sm relative">
                            <thead class="bg-white text-xs uppercase text-slate-500 border-b border-slate-100 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 md:px-6 py-3 w-5/12 bg-white" data-i18n="col_prod">Producto</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-ene hidden md:table-cell" data-i18n="col_jan">Enero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-feb hidden md:table-cell" data-i18n="col_feb">Febrero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-slate-50 font-bold" data-i18n="col_sum_2025">Total 2025</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white w-16 md:w-24"></th>
                                </tr>
                            </thead>
                            <tbody id="tbody-2025" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- LÃ“GICA DE NEGOCIO -->
    <script>
        // --- DICCIONARIO ---
        const translations = {
            es: {
                dashboard_title: "Dashboard Comercial",
                tab_bimester: "1er Bimestre",
                tab_bimester_sub: "(Ene + Feb)",
                tab_feb: "Solo Febrero",
                tab_feb_sub: "(Comparativo Mes)",
                metric_kg: "Consumo (KG)",
                metric_money: "FacturaciÃ³n ($)",
                search_placeholder: "Buscar cliente...",
                hide_small_label: "Ocultar clientes con consumos pequeÃ±os",
                col_client: "Cliente",
                col_total_2025: "Total 2025",
                col_total_2026: "Total 2026",
                col_feb_2025: "Feb 2025",
                col_feb_2026: "Feb 2026",
                loading: "Cargando datos...",
                footer_listed: "Clientes listados",
                empty_state: "Selecciona un cliente para ver su desglose",
                detail_subtitle_bim: "Comparativo Primer Bimestre (Ene + Feb)",
                detail_subtitle_feb: "Comparativo Mensual (Febrero)",
                header_cons_2025: "Consumo 2025",
                header_cons_2026: "Consumo 2026",
                header_fact_2025: "FacturaciÃ³n 2025",
                header_fact_2026: "FacturaciÃ³n 2026",
                col_prod: "Producto",
                col_jan: "Enero",
                col_feb: "Febrero",
                col_sum_2025: "Total 2025",
                col_sum_2026: "Total 2026",
                col_growth: "% Crec.",
                group_new: "ðŸŒŸ Clientes Nuevos",
                group_high: "Crecimiento > 10%",
                group_stable: "Estables (0% - 10%)",
                group_neg: "Decrecimiento",
                badge_new: "NUEVO",
                no_records: "Sin registros en este periodo",
                no_records_year: "Sin registros en",
                btn_invoices: "Ver Facturas",
                modal_title_prefix: "Facturas",
                th_invoice: "# Factura",
                th_amount: "Monto",
                back_list: "Volver a la lista",
                // PDF KEYS
                pdf_title: "Reporte de DesempeÃ±o Comercial",
                pdf_client: "CLIENTE:",
                pdf_period: "PERIODO:",
                pdf_gen_date: "Fecha de generaciÃ³n:",
                pdf_sec_invoices: "DETALLE DE FACTURAS",
                pdf_col_date: "Fecha",
                pdf_col_inv: "Factura",
                pdf_col_desc: "DescripciÃ³n",
                pdf_col_qty: "Cant.",
                pdf_col_unit: "Precio U.",
                pdf_col_total: "Total",
                pdf_sec_varieties: "RESUMEN POR VARIEDAD (KG)",
                pdf_col_var: "Variedad",
                pdf_col_kg: "Total KG",
                pdf_sec_analysis: "ANÃLISIS DE DESEMPEÃ‘O",
                pdf_growth_gen: "Crecimiento General:",
                pdf_alert_title: "âš ï¸ PRODUCTOS CON CAÃDA CRÃTICA (>10%)",
                pdf_alert_msg: "Se recomienda revisar el consumo de los siguientes productos:"
            },
            fr: {
                dashboard_title: "Tableau de Bord Commercial",
                tab_bimester: "1er Bimestre",
                tab_bimester_sub: "(Jan + FÃ©v)",
                tab_feb: "FÃ©vrier Uniq.",
                tab_feb_sub: "(Comparatif Mois)",
                metric_kg: "Conso. (KG)",
                metric_money: "Facturation ($)",
                search_placeholder: "Rechercher client...",
                hide_small_label: "Masquer les clients Ã  faible consommation",
                col_client: "Client",
                col_total_2025: "Total 2025",
                col_total_2026: "Total 2026",
                col_feb_2025: "FÃ©v 2025",
                col_feb_2026: "FÃ©v 2026",
                loading: "Chargement des donnÃ©es...",
                footer_listed: "Clients listÃ©s",
                empty_state: "SÃ©lectionnez un client pour voir les dÃ©tails",
                detail_subtitle_bim: "Comparatif 1er Bimestre (Jan + FÃ©v)",
                detail_subtitle_feb: "Comparatif Mensuel (FÃ©vrier)",
                header_cons_2025: "Consommation 2025",
                header_cons_2026: "Consommation 2026",
                header_fact_2025: "Facturation 2025",
                header_fact_2026: "Facturation 2026",
                col_prod: "Produit",
                col_jan: "Janvier",
                col_feb: "FÃ©vrier",
                col_sum_2025: "Total",
                col_sum_2026: "Total",
                col_growth: "% Crois.",
                group_new: "ðŸŒŸ Nouveaux Clients",
                group_high: "Croissance > 10%",
                group_stable: "Stables (0% - 10%)",
                group_neg: "DÃ©croissance",
                badge_new: "NOUVEAU",
                no_records: "Aucun enregistrement pour cette pÃ©riode",
                no_records_year: "Aucun enregistrement en",
                btn_invoices: "Voir Factures",
                modal_title_prefix: "Factures",
                th_invoice: "# Facture",
                th_amount: "Montant",
                back_list: "Retour Ã  la liste",
                // PDF KEYS
                pdf_title: "Rapport de Performance Commerciale",
                pdf_client: "CLIENT:",
                pdf_period: "PÃ‰RIODE:",
                pdf_gen_date: "Date de gÃ©nÃ©ration:",
                pdf_sec_invoices: "DÃ‰TAIL DES FACTURES",
                pdf_col_date: "Date",
                pdf_col_inv: "Facture",
                pdf_col_desc: "Description",
                pdf_col_qty: "QtÃ©.",
                pdf_col_unit: "Prix U.",
                pdf_col_total: "Total",
                pdf_sec_varieties: "RÃ‰SUMÃ‰ PAR VARIÃ‰TÃ‰ (KG)",
                pdf_col_var: "VariÃ©tÃ©",
                pdf_col_kg: "Total KG",
                pdf_sec_analysis: "ANALYSE DE PERFORMANCE",
                pdf_growth_gen: "Croissance GÃ©nÃ©rale:",
                pdf_alert_title: "âš ï¸ PRODUITS EN BAISSE CRITIQUE (>10%)",
                pdf_alert_msg: "Il est recommandÃ© de vÃ©rifier la consommation des produits suivants:"
            }
        };

        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycby-LHBHTiAdtRFn9FLY0urdS1XYzVPbTXiUFdYWC_Jm7tD7r06-9MnhtNspbBxnGgeR/exec",
            MOCK_DATA: [
                { id: "m1", nombre: "Cliente Ejemplo 1", ventas2025: 100, ventas2026: 200, peso2025: 50, peso2026: 100, productos: [], facturas: [] }
            ]
        };

        let state = { 
            allData: [], 
            selectedId: null, 
            searchTerm: "", 
            viewMode: 'february', 
            metricMode: 'weight',
            isDemo: false, 
            lang: 'es',
            hideSmall: true
        };

        function t(key) { return translations[state.lang][key] || key; }

        window.changeLanguage = (lang) => {
            state.lang = lang;
            document.getElementById('lang-es').classList.toggle('active', lang === 'es');
            document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.getElementById('search-input').placeholder = t('search_placeholder');
            updateUI();
            if(state.selectedId) {
                const client = state.allData.find(c => c.id === state.selectedId);
                if(client) renderDetail(client);
            }
        };

        const formatCurrency = (val) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val || 0);
        const formatWeight = (val) => new Intl.NumberFormat('es-MX', { maximumFractionDigits: 1 }).format(val || 0) + ' kg';
        const formatPercent = (val) => `${val > 0 ? '+' : ''}${val.toFixed(1)}%`;

        function getDualValueHTML(valMoney, valWeight, align = 'text-right') {
            const moneyStr = formatCurrency(valMoney);
            const weightStr = formatWeight(valWeight);
            if (state.metricMode === 'weight') {
                return `<div class="flex flex-col ${align}"><span class="font-bold text-slate-800 text-[11px] md:text-xs">${weightStr}</span><span class="text-[9px] text-slate-400 font-normal">${moneyStr}</span></div>`;
            } else {
                return `<div class="flex flex-col ${align}"><span class="font-bold text-slate-800 text-[11px] md:text-xs">${moneyStr}</span><span class="text-[9px] text-slate-400 font-normal">${weightStr}</span></div>`;
            }
        }

        async function initApp() {
            try {
                const url = `${CONFIG.API_URL}?t=${Date.now()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Error");
                const text = await response.text();
                state.allData = JSON.parse(text);
                state.isDemo = false;
            } catch (err) {
                console.warn(err);
                state.allData = CONFIG.MOCK_DATA;
                state.isDemo = true;
                document.getElementById('status-bar').classList.remove('hidden');
                document.getElementById('status-text').textContent = "Modo Demo";
            } finally {
                document.getElementById('list-loader').classList.add('hidden');
                const userLang = navigator.language || navigator.userLanguage;
                if (userLang.toLowerCase().startsWith('fr')) changeLanguage('fr');
                else changeLanguage('es');
                updateHeaders();
            }
        }

        // --- PDF GENERATION LOGIC ---
        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const client = state.allData.find(c => c.id === state.selectedId);
            if (!client || !client.transacciones) return;

            const doc = new jsPDF();
            const year = 2026; 
            
            // --- HEADER ---
            doc.setFontSize(18);
            doc.setTextColor(30, 58, 138); 
            doc.text(t('pdf_title'), 14, 20);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`${t('pdf_gen_date')} ${new Date().toLocaleDateString()}`, 14, 28);

            // --- CLIENT INFO ---
            doc.setDrawColor(200);
            doc.line(14, 32, 196, 32);
            
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text(`${t('pdf_client')} ${client.nombre}`, 14, 40);
            const periodText = state.viewMode === 'bimester' ? t('tab_bimester') : t('tab_feb');
            doc.text(`${t('pdf_period')} ${periodText} ${year}`, 14, 46);

            // --- 1. TABLA DETALLE FACTURAS ---
            doc.setFontSize(11);
            doc.setTextColor(30, 58, 138);
            doc.text(t('pdf_sec_invoices'), 14, 58);

            // Filtrar transacciones segÃºn vista
            const transactions = client.transacciones.filter(t => {
                if (t.anio !== year) return false;
                if (state.viewMode === 'february' && t.mes !== 1) return false;
                return true;
            });

            const bodyData = transactions.map(row => [
                row.fecha,
                row.factura,
                row.producto,
                row.cantidad,
                formatCurrency(row.precioU),
                formatCurrency(row.total)
            ]);

            doc.autoTable({
                startY: 62,
                head: [[t('pdf_col_date'), t('pdf_col_inv'), t('pdf_col_desc'), t('pdf_col_qty'), t('pdf_col_unit'), t('pdf_col_total')]],
                body: bodyData,
                theme: 'striped',
                headStyles: { fillColor: [30, 58, 138] },
                styles: { fontSize: 8 },
                columnStyles: { 2: { cellWidth: 70 } } 
            });

            // --- 2. RESUMEN POR VARIEDAD (KG) ---
            let finalY = doc.lastAutoTable.finalY + 15;
            
            doc.setFontSize(11);
            doc.setTextColor(30, 58, 138);
            doc.text(t('pdf_sec_varieties'), 14, finalY);

            // Agrupar por variedad
            const varietyMap = {};
            transactions.forEach(t => {
                if (!varietyMap[t.variedad]) varietyMap[t.variedad] = 0;
                varietyMap[t.variedad] += (t.peso || 0);
            });
            const varietyData = Object.entries(varietyMap)
                .filter(([_, weight]) => weight > 0)
                .map(([name, weight]) => [name, formatWeight(weight)]);

            doc.autoTable({
                startY: finalY + 4,
                head: [[t('pdf_col_var'), t('pdf_col_kg')]],
                body: varietyData,
                theme: 'grid',
                headStyles: { fillColor: [71, 85, 105] }, // Slate-600
                styles: { fontSize: 9 },
                tableWidth: 100
            });

            // --- 3. ANÃLISIS ---
            // Calcular crecimiento general
            const vals = getClientValues(client);
            const base = state.metricMode === 'weight' ? vals.weight25 : vals.money25;
            const curr = state.metricMode === 'weight' ? vals.weight26 : vals.money26;
            
            let growthText = "-";
            let color = [0, 0, 0];
            if (base > 0) {
                const pct = ((curr - base) / base) * 100;
                growthText = formatPercent(pct);
                if (pct < 0) color = [220, 38, 38]; 
                else color = [22, 163, 74]; 
            }

            finalY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(11);
            doc.setTextColor(30, 58, 138);
            doc.text(t('pdf_sec_analysis'), 14, finalY);
            
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.text(`${t('pdf_growth_gen')} `, 14, finalY + 7);
            doc.setTextColor(color[0], color[1], color[2]);
            doc.setFont(undefined, 'bold');
            doc.text(growthText, 60, finalY + 7);
            doc.setFont(undefined, 'normal');

            // Encontrar productos con caÃ­da > 10%
            const alertProducts = client.productos.filter(p => {
                const p25Raw = getProductData(p, 2025);
                const pBase = state.viewMode === 'bimester' 
                    ? (state.metricMode==='weight' ? p25Raw.w_total : p25Raw.m_total)
                    : (state.metricMode==='weight' ? p25Raw.w_feb : p25Raw.m_feb);
                
                const pCurr = state.viewMode === 'bimester'
                    ? (state.metricMode==='weight' ? (p.w26_total || (p.w26_ene+p.w26_feb)) : (p.v26_total || (p.v26_ene+p.v26_feb)))
                    : (state.metricMode==='weight' ? p.w26_feb : p.v26_feb);

                if (pBase > 0) {
                    const drop = ((pCurr - pBase) / pBase) * 100;
                    return drop < -10;
                }
                return false;
            });

            if (alertProducts.length > 0) {
                doc.setTextColor(220, 38, 38);
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text(t('pdf_alert_title'), 14, finalY + 15);
                
                doc.setFont(undefined, 'normal');
                doc.setTextColor(50);
                doc.text(t('pdf_alert_msg'), 14, finalY + 20);

                let yPos = finalY + 26;
                alertProducts.forEach(p => {
                    doc.text(`â€¢ ${p.nombre}`, 18, yPos);
                    yPos += 5;
                });
            }

            doc.save(`${client.nombre}_Reporte.pdf`);
        };

        window.changeView = (mode) => {
            state.viewMode = mode;
            const btnFeb = document.getElementById('tab-february');
            const btnBim = document.getElementById('tab-bimester');
            const activeClass = "flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-active touch-manipulation";
            const inactiveClass = "flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-inactive touch-manipulation";
            if (mode === 'february') { btnFeb.className = activeClass; btnBim.className = inactiveClass; } 
            else { btnFeb.className = inactiveClass; btnBim.className = activeClass; }
            updateHeaders(); updateUI();
            if (state.selectedId) { const client = state.allData.find(c => c.id === state.selectedId); if (client) renderDetail(client); }
        };

        window.changeMetric = (metric) => {
            state.metricMode = metric;
            document.getElementById('metric-weight').classList.toggle('active', metric === 'weight');
            document.getElementById('metric-money').classList.toggle('active', metric === 'money');
            updateHeaders(); updateUI();
            if (state.selectedId) { const client = state.allData.find(c => c.id === state.selectedId); if (client) renderDetail(client); }
        };

        window.toggleHideSmall = (isChecked) => { state.hideSmall = isChecked; updateUI(); };

        function updateHeaders() {
            const header25 = document.querySelector('.header-year-2025');
            const header26 = document.querySelector('.header-year-2026');
            if(header25 && header26) {
                header25.textContent = state.viewMode === 'bimester' ? t('col_total_2025') : t('col_feb_2025');
                header26.textContent = state.viewMode === 'bimester' ? t('col_total_2026') : t('col_feb_2026');
            }
            const detailH25 = document.getElementById('header-2025');
            const detailH26 = document.getElementById('header-2026');
            if(detailH25 && detailH26) {
                const keyPrefix = state.metricMode === 'weight' ? 'header_cons_' : 'header_fact_';
                detailH25.textContent = t(keyPrefix + '2025');
                detailH26.textContent = t(keyPrefix + '2026');
            }
        }

        function getClientValues(client) {
            if (state.viewMode === 'bimester') {
                return { money25: client.ventas2025, money26: client.ventas2026, weight25: client.peso2025, weight26: client.peso2026 };
            } else {
                let m25=0, m26=0, w25=0, w26=0;
                client.productos.forEach(p => {
                    m25 += (p.v25_feb || 0); m26 += (p.v26_feb || 0); w25 += (p.w25_feb || 0); w26 += (p.w26_feb || 0);
                });
                return { money25: m25, money26: m26, weight25: w25, weight26: w26 };
            }
        }

        function updateUI() {
            let processed = state.allData
                .filter(c => c.nombre.toLowerCase().includes(state.searchTerm.toLowerCase()))
                .map(c => {
                    const vals = getClientValues(c);
                    const primary25 = state.metricMode === 'weight' ? vals.weight25 : vals.money25;
                    const primary26 = state.metricMode === 'weight' ? vals.weight26 : vals.money26;
                    let growth = 0; let isNew = false;
                    if (primary25 > 0) { growth = ((primary26 - primary25) / primary25) * 100; } 
                    else if (primary26 > 0) { growth = 100; isNew = true; } 
                    else if (primary25 > 0 && primary26 === 0) { growth = -100; }
                    return { ...c, vals, growth, isNew, primary26 }; 
                });

            if (state.hideSmall) {
                processed = processed.filter(item => (item.vals.weight25 + item.vals.weight26) > 20);
            }

            const newClients = processed.filter(c => c.isNew).sort((a,b) => b.primary26 - a.primary26);
            const highGrowth = processed.filter(c => !c.isNew && c.growth > 10).sort((a,b) => a.nombre.localeCompare(b.nombre));
            const stableGrowth = processed.filter(c => !c.isNew && c.growth >= 0 && c.growth <= 10).sort((a,b) => a.nombre.localeCompare(b.nombre));
            const negativeGrowth = processed.filter(c => !c.isNew && c.growth < 0).sort((a,b) => a.growth - b.growth);

            const container = document.getElementById('clients-list');
            Array.from(container.children).forEach(child => { if (child.id !== 'list-loader') container.removeChild(child); });

            renderGroup(container, newClients, t('group_new'), "text-purple-700 bg-purple-50 border-purple-100");
            renderGroup(container, highGrowth, t('group_high'), "text-green-700 bg-green-50 border-green-100");
            renderGroup(container, stableGrowth, t('group_stable'), "text-blue-700 bg-blue-50 border-blue-100");
            renderGroup(container, negativeGrowth, t('group_neg'), "text-red-700 bg-red-50 border-red-100");
            document.getElementById('list-footer').textContent = `${processed.length} ${t('footer_listed')}`;
        }

        function renderGroup(container, items, title, classes) {
            if (items.length === 0) return;
            const header = document.createElement('div');
            header.className = `sticky top-0 z-10 px-4 py-1.5 border-y text-[10px] font-bold uppercase tracking-wide flex items-center justify-between backdrop-blur-sm bg-opacity-95 ${classes}`;
            header.innerHTML = `<span>${title}</span><span class="bg-white/50 px-1.5 rounded-full">${items.length}</span>`;
            container.appendChild(header);
            items.forEach(item => {
                const el = document.createElement('div');
                const isSelected = item.id === state.selectedId;
                let baseClass = "grid grid-cols-12 px-4 py-3 border-b border-slate-50 cursor-pointer transition-all duration-200 items-center relative group ";
                if (isSelected) baseClass += "bg-blue-50/60 "; else baseClass += "hover:bg-slate-50 ";
                el.className = baseClass;
                el.onclick = () => { selectClient(item); };
                let badge = '';
                const primary25 = state.metricMode === 'weight' ? item.vals.weight25 : item.vals.money25;
                const primary26 = state.metricMode === 'weight' ? item.vals.weight26 : item.vals.money26;
                if (item.isNew) {
                    badge = `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] mt-1 font-bold bg-purple-100 text-purple-700 border border-purple-200">âœ¨ ${t('badge_new')}</span>`;
                } else if (primary25 > 0 || primary26 > 0) {
                    const color = item.growth >= 0 ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200';
                    const icon = item.growth >= 0 ? 'â–²' : 'â–¼';
                    badge = `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] mt-1 font-medium border ${color}">${icon} ${Math.abs(item.growth).toFixed(1)}%</span>`;
                }
                const activeBorder = isSelected ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-600 rounded-r"></div>' : '';
                el.innerHTML = `${activeBorder}<div class="col-span-6 pr-2 pl-2"><p class="text-xs font-bold text-wrap ${isSelected ? 'text-blue-700' : 'text-slate-700'}">${item.nombre}</p>${badge}</div><div class="col-span-3">${getDualValueHTML(item.vals.money25, item.vals.weight25)}</div><div class="col-span-3">${getDualValueHTML(item.vals.money26, item.vals.weight26)}</div>`;
                container.appendChild(el);
            });
        }

        function selectClient(item) {
            state.selectedId = item.id;
            updateUI(); 
            renderDetail(item);
            if (window.innerWidth < 768) {
                document.getElementById('left-panel').classList.add('hidden');
                document.getElementById('detail-panel').classList.remove('hidden', 'md:flex');
                document.getElementById('detail-panel').classList.add('flex');
            }
        }

        window.backToMobileList = () => {
            document.getElementById('left-panel').classList.remove('hidden');
            document.getElementById('detail-panel').classList.add('hidden');
            document.getElementById('detail-panel').classList.remove('flex');
            state.selectedId = null;
            updateUI();
        }

        function renderDetail(client) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('detail-content').classList.remove('hidden');
            const vals = getClientValues(client);
            document.getElementById('detail-title').textContent = client.nombre;
            document.getElementById('detail-subtitle').textContent = state.viewMode === 'bimester' ? t('detail_subtitle_bim') : t('detail_subtitle_feb');
            document.getElementById('total-2025').innerHTML = getDualValueHTML(vals.money25, vals.weight25);
            document.getElementById('total-2026').innerHTML = getDualValueHTML(vals.money26, vals.weight26);
            const displayEne = state.viewMode === 'bimester' ? 'table-cell' : 'none';
            document.querySelectorAll('.col-ene').forEach(el => el.style.display = displayEne);
            updateHeaders();
            renderDetailTable('tbody-2025', client.productos, 2025);
            renderDetailTable('tbody-2026', client.productos, 2026);
        }

        function renderDetailTable(tbodyId, products, year) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            const items = products.map(p => {
                const prefix = year === 2026 ? '26' : '25';
                const m_ene = p[`v${prefix}_ene`] || 0; const m_feb = p[`v${prefix}_feb`] || 0;
                const w_ene = p[`w${prefix}_ene`] || 0; const w_feb = p[`w${prefix}_feb`] || 0;
                const m_total = state.viewMode === 'bimester' ? (p[`v${prefix}_total`] || (m_ene+m_feb)) : m_feb;
                const w_total = state.viewMode === 'bimester' ? (p[`w${prefix}_total`] || (w_ene+w_feb)) : w_feb;
                const primary = state.metricMode === 'weight' ? w_total : m_total;
                return { ...p, m_ene, m_feb, w_ene, w_feb, m_total, w_total, primary };
            }).filter(p => p.primary > 0).sort((a,b) => b.primary - a.primary);

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400 italic">${t('no_records_year')} ${year}</td></tr>`;
                return;
            }

            items.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 group border-b border-slate-50 last:border-0";
                let growthCell = '';
                if (year === 2026) {
                    const p25Raw = getProductData(p, 2025); 
                    const m25 = state.viewMode === 'bimester' ? p25Raw.m_total : p25Raw.m_feb;
                    const w25 = state.viewMode === 'bimester' ? p25Raw.w_total : p25Raw.w_feb;
                    const base = state.metricMode === 'weight' ? w25 : m25;
                    const current = state.metricMode === 'weight' ? p.w_total : p.m_total;
                    let badge = '<span class="text-slate-300 text-xs">-</span>';
                    if (base > 0) {
                        const pct = ((current - base) / base) * 100;
                        const color = pct >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                        const icon = pct >= 0 ? 'â–²' : 'â–¼';
                        badge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs ${color} font-bold">${icon} ${Math.abs(pct).toFixed(1)}%</span>`;
                    } else if (current > 0) {
                        badge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-700 font-bold">${t('badge_new')}</span>`;
                    }
                    growthCell = `<td class="px-4 md:px-6 py-3 text-right">${badge}</td>`;
                } else { growthCell = `<td class="px-4 md:px-6 py-3"></td>`; }
                const displayEne = state.viewMode === 'bimester' ? '' : 'display:none;';
                tr.innerHTML = `<td class="px-4 md:px-6 py-3 font-medium text-slate-700 break-words w-5/12 text-xs sm:text-sm">${p.nombre}</td><td class="px-4 md:px-6 py-3" style="${displayEne}">${getDualValueHTML(p.m_ene, p.w_ene)}</td><td class="px-4 md:px-6 py-3">${getDualValueHTML(p.m_feb, p.w_feb)}</td><td class="px-4 md:px-6 py-3 bg-slate-50/50">${getDualValueHTML(p.m_total, p.w_total)}</td>${growthCell}`;
                tbody.appendChild(tr);
            });
        }

        function getProductData(rawProd, year) {
            const prefix = '25';
            const m_ene = rawProd[`v${prefix}_ene`] || 0; const m_feb = rawProd[`v${prefix}_feb`] || 0; const m_total = rawProd[`v${prefix}_total`] || 0;
            const w_ene = rawProd[`w${prefix}_ene`] || 0; const w_feb = rawProd[`w${prefix}_feb`] || 0; const w_total = rawProd[`w${prefix}_total`] || 0;
            return { m_ene, m_feb, m_total, w_ene, w_feb, w_total };
        }

        window.openInvoiceModal = (year) => {
            const client = state.allData.find(c => c.id === state.selectedId);
            if (!client || !client.facturas) return;
            const modal = document.getElementById('invoice-modal');
            const tbody = document.getElementById('modal-tbody');
            tbody.innerHTML = '';
            const filteredInvoices = client.facturas.filter(f => {
                if (f.anio !== year) return false;
                if (state.viewMode === 'february' && f.mes !== 1) return false;
                return true;
            });
            document.getElementById('modal-title').textContent = `${t('modal_title_prefix')} ${year}`;
            document.getElementById('modal-subtitle').textContent = state.viewMode === 'bimester' ? t('tab_bimester') : t('tab_feb');
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="px-6 py-8 text-center text-slate-400 italic">${t('no_records')}</td></tr>`;
                document.getElementById('modal-total').textContent = formatCurrency(0);
                document.getElementById('modal-count').textContent = "0 facturas";
            } else {
                let total = 0;
                filteredInvoices.sort((a,b) => b.monto - a.monto).forEach(f => {
                    total += f.monto;
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 border-b border-slate-50";
                    tr.innerHTML = `<td class="px-6 py-3 font-mono text-xs text-blue-600 font-bold">${f.numero}</td><td class="px-6 py-3 text-right font-mono text-slate-700">${formatCurrency(f.monto)}</td>`;
                    tbody.appendChild(tr);
                });
                document.getElementById('modal-total').textContent = formatCurrency(total);
                document.getElementById('modal-count').textContent = `${filteredInvoices.length} facturas`;
            }
            modal.classList.remove('hidden');
        };

        window.closeModal = () => { document.getElementById('invoice-modal').classList.add('hidden'); };
        document.getElementById('invoice-modal').addEventListener('click', (e) => { if (e.target.id === 'invoice-modal') closeModal(); });
        document.getElementById('search-input').addEventListener('input', (e) => { state.searchTerm = e.target.value; updateUI(); });

        initApp();
    </script>
</body>
</html>
