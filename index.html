<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard Comercial</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.2s ease-out forwards; }
        
        .tab-active { 
            background-color: #1e3a8a; 
            color: white; 
            border: 2px solid #1e3a8a; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-inactive { background-color: white; color: #64748b; border: 2px solid #cbd5e1; }
        .tab-inactive:hover { background-color: #f1f5f9; color: #334155; border-color: #94a3b8; }

        .lang-btn { opacity: 0.6; filter: grayscale(100%); transition: all 0.2s; }
        .lang-btn.active { opacity: 1; filter: grayscale(0%); transform: scale(1.1); font-weight: bold; text-decoration: underline; text-decoration-color: #2563eb; text-underline-offset: 4px; }
        
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans text-slate-800 overflow-hidden">

    <!-- MODAL DE FACTURAS -->
    <div id="invoice-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay p-4 animate-fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span id="modal-title">Facturas</span>
                    </h3>
                    <p id="modal-subtitle" class="text-xs text-slate-500 mt-1"></p>
                </div>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto custom-scrollbar p-0">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-xs uppercase text-slate-500 sticky top-0 border-b border-slate-200 shadow-sm">
                        <tr>
                            <th class="px-6 py-3 font-semibold" data-i18n="th_invoice"># Factura</th>
                            <th class="px-6 py-3 font-semibold text-right" data-i18n="th_amount">Monto</th>
                        </tr>
                    </thead>
                    <tbody id="modal-tbody" class="divide-y divide-slate-100 text-slate-700">
                        <!-- Contenido dinÃ¡mico -->
                    </tbody>
                </table>
            </div>
            
            <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-xl flex justify-between items-center">
                <span class="text-xs text-slate-500" id="modal-count"></span>
                <span class="text-sm font-bold text-slate-800" id="modal-total"></span>
            </div>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div id="status-bar" class="hidden px-4 py-2 text-xs font-medium flex justify-between items-center border-b shadow-sm z-40 bg-white">
        <span id="status-text" class="flex items-center gap-2"></span>
        <button onclick="window.location.reload()" class="underline ml-4">Recargar</button>
    </div>

    <div class="flex flex-1 overflow-hidden relative" id="main-container">
        
        <!-- PANEL IZQUIERDO (LISTA) -->
        <div id="left-panel" class="w-full md:w-5/12 lg:w-1/3 bg-white border-r border-slate-200 flex flex-col shadow-xl z-20 absolute inset-0 md:relative transition-transform duration-300">
            <div class="bg-slate-50 border-b border-slate-200 p-4 pb-2">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2 max-w-[65%] leading-tight" data-i18n="dashboard_title">
                        <svg class="w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        Dashboard Comercial
                    </h2>
                    <div class="flex gap-2 bg-white px-2 py-1 rounded-full border border-slate-200 shadow-sm flex-shrink-0">
                        <button onclick="changeLanguage('es')" id="lang-es" class="lang-btn active text-xs flex items-center gap-1"><span>MX</span> ðŸ‡²ðŸ‡½</button>
                        <div class="w-px bg-slate-200 h-4 self-center"></div>
                        <button onclick="changeLanguage('fr')" id="lang-fr" class="lang-btn text-xs flex items-center gap-1"><span>FR</span> ðŸ‡«ðŸ‡·</button>
                    </div>
                </div>
                
                <!-- PESTAÃ‘AS (MÃS GRANDES PARA TOUCH) -->
                <div class="flex gap-2 mb-3">
                    <button onclick="changeView('february')" id="tab-february" class="flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-active touch-manipulation">
                        <span data-i18n="tab_feb">Solo Febrero</span><br/><span class="font-normal opacity-80 text-[10px] md:text-[9px]" data-i18n="tab_feb_sub">(Comparativo Mes)</span>
                    </button>
                    <button onclick="changeView('bimester')" id="tab-bimester" class="flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-inactive touch-manipulation">
                        <span data-i18n="tab_bimester">1er Bimestre</span><br/><span class="font-normal opacity-80 text-[10px] md:text-[9px]" data-i18n="tab_bimester_sub">(Ene + Feb)</span>
                    </button>
                </div>

                <div class="relative mt-2">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></div>
                    <input type="text" id="search-input" placeholder="Buscar cliente..." class="w-full pl-9 pr-3 py-3 md:py-2 text-sm border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white transition-all shadow-sm">
                </div>
            </div>
            <!-- ENCABEZADOS -->
            <div class="grid grid-cols-12 px-4 py-3 bg-slate-100 border-b border-slate-200 text-[10px] font-bold text-slate-500 uppercase tracking-wider sticky top-0 z-10">
                <div class="col-span-6 pl-1" data-i18n="col_client">Cliente</div>
                <div class="col-span-3 text-right header-year-2025">2025</div>
                <div class="col-span-3 text-right header-year-2026">2026</div>
            </div>
            <div id="clients-list" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 relative">
                <div id="list-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10">
                    <svg class="animate-spin h-10 w-10 text-blue-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <span class="text-xs text-slate-500 animate-pulse" data-i18n="loading">Cargando datos...</span>
                </div>
            </div>
            <div id="list-footer" class="p-3 bg-slate-50 border-t border-slate-200 text-[10px] text-slate-400 text-center font-medium">0 Clientes listados</div>
        </div>

        <!-- PANEL DERECHO (DETALLE) -->
        <div id="detail-panel" class="w-full md:w-7/12 lg:w-2/3 flex flex-col h-full bg-slate-100 overflow-y-auto p-4 md:p-6 gap-6 custom-scrollbar absolute inset-0 md:relative z-30 hidden md:flex">
            
            <!-- BOTÃ“N VOLVER (SOLO MÃ“VIL) -->
            <button onclick="backToMobileList()" class="md:hidden flex items-center gap-2 text-slate-500 hover:text-blue-600 font-medium mb-2 w-fit">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span data-i18n="back_list">Volver a la lista</span>
            </button>

            <div id="empty-state" class="flex-1 flex flex-col items-center justify-center text-slate-400">
                <svg class="w-20 h-20 mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <p data-i18n="empty_state">Selecciona un cliente para ver su desglose</p>
            </div>
            
            <div id="detail-content" class="hidden flex-col gap-6 animate-fade-in pb-8">
                <div class="flex flex-col border-b border-slate-200 pb-4">
                    <h1 id="detail-title" class="text-xl md:text-3xl font-bold text-slate-800 break-words leading-tight"></h1>
                    <p id="detail-subtitle" class="text-sm text-slate-500 mt-1"></p>
                </div>

                <!-- Tabla 2026 -->
                <div class="bg-white rounded-xl shadow-sm border border-blue-200 ring-2 ring-blue-50 overflow-hidden">
                    <div class="bg-blue-50 px-4 md:px-6 py-3 border-b border-blue-100 flex flex-wrap justify-between items-center sticky top-0 z-20 gap-2">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-blue-900 text-sm"><span data-i18n="fact_2026">FacturaciÃ³n 2026</span></h3>
                            <button onclick="openInvoiceModal(2026)" class="text-[10px] bg-white border border-blue-300 hover:bg-blue-50 text-blue-700 px-2 py-1 rounded shadow-sm flex items-center transition-colors active:scale-95">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span data-i18n="btn_invoices">Ver Facturas</span>
                            </button>
                        </div>
                        <span id="total-2026" class="bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded font-mono font-bold"></span>
                    </div>
                    <div class="overflow-auto max-h-[350px] custom-scrollbar">
                        <table class="w-full text-left text-sm relative">
                            <thead class="bg-white text-xs uppercase text-slate-500 border-b border-blue-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 md:px-6 py-3 w-5/12 bg-white" data-i18n="col_prod">Producto</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-ene hidden md:table-cell" data-i18n="col_jan">Enero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-feb hidden md:table-cell" data-i18n="col_feb">Febrero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-blue-50/50 font-bold text-blue-800" data-i18n="col_sum_2026">Total 2026</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white font-bold w-16 md:w-24" data-i18n="col_growth">% Crec.</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-2026" class="divide-y divide-blue-50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabla 2025 -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 md:px-6 py-3 border-b border-slate-200 flex flex-wrap justify-between items-center sticky top-0 z-20 gap-2">
                        <div class="flex items-center gap-3">
                            <h3 class="font-bold text-slate-700 text-sm"><span data-i18n="fact_2025">FacturaciÃ³n 2025</span></h3>
                            <button onclick="openInvoiceModal(2025)" class="text-[10px] bg-white border border-slate-300 hover:bg-slate-100 text-slate-600 px-2 py-1 rounded shadow-sm flex items-center transition-colors active:scale-95">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span data-i18n="btn_invoices">Ver Facturas</span>
                            </button>
                        </div>
                        <span id="total-2025" class="bg-slate-200 text-slate-600 text-xs px-2 py-1 rounded font-mono font-bold"></span>
                    </div>
                    <div class="overflow-auto max-h-[350px] custom-scrollbar">
                        <table class="w-full text-left text-sm relative">
                            <thead class="bg-white text-xs uppercase text-slate-500 border-b border-slate-100 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="px-4 md:px-6 py-3 w-5/12 bg-white" data-i18n="col_prod">Producto</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-ene hidden md:table-cell" data-i18n="col_jan">Enero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white col-feb hidden md:table-cell" data-i18n="col_feb">Febrero</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-slate-50 font-bold" data-i18n="col_sum_2025">Total 2025</th>
                                    <th class="px-4 md:px-6 py-3 text-right bg-white w-16 md:w-24"></th>
                                </tr>
                            </thead>
                            <tbody id="tbody-2025" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- LÃ“GICA DE NEGOCIO -->
    <script>
        const translations = {
            es: {
                dashboard_title: "Dashboard Comercial",
                tab_bimester: "1er Bimestre",
                tab_bimester_sub: "(Ene + Feb)",
                tab_feb: "Solo Febrero",
                tab_feb_sub: "(Comparativo Mes)",
                search_placeholder: "Buscar cliente...",
                col_client: "Cliente",
                col_total_2025: "Total 2025",
                col_total_2026: "Total 2026",
                col_feb_2025: "Feb 2025",
                col_feb_2026: "Feb 2026",
                loading: "Cargando datos...",
                footer_listed: "Clientes listados",
                empty_state: "Selecciona un cliente para ver su desglose",
                detail_subtitle_bim: "Comparativo Primer Bimestre (Ene + Feb)",
                detail_subtitle_feb: "Comparativo Mensual (Febrero)",
                fact_2025: "FacturaciÃ³n 2025",
                fact_2026: "FacturaciÃ³n 2026",
                col_prod: "Producto",
                col_jan: "Enero",
                col_feb: "Febrero",
                col_sum_2025: "Total 2025",
                col_sum_2026: "Total 2026",
                col_growth: "% Crec.",
                group_new: "ðŸŒŸ Clientes Nuevos",
                group_high: "Crecimiento > 10%",
                group_stable: "Estables (0% - 10%)",
                group_neg: "Decrecimiento",
                badge_new: "NUEVO",
                no_records: "Sin registros en este periodo",
                no_records_year: "Sin registros en",
                btn_invoices: "Ver Facturas",
                modal_title_prefix: "Facturas",
                th_invoice: "# Factura",
                th_amount: "Monto",
                back_list: "Volver a la lista"
            },
            fr: {
                dashboard_title: "Tableau de Bord Commercial",
                tab_bimester: "1er Bimestre",
                tab_bimester_sub: "(Jan + FÃ©v)",
                tab_feb: "FÃ©vrier Uniq.",
                tab_feb_sub: "(Comparatif Mois)",
                search_placeholder: "Rechercher client...",
                col_client: "Client",
                col_total_2025: "Total 2025",
                col_total_2026: "Total 2026",
                col_feb_2025: "FÃ©v 2025",
                col_feb_2026: "FÃ©v 2026",
                loading: "Chargement des donnÃ©es...",
                footer_listed: "Clients listÃ©s",
                empty_state: "SÃ©lectionnez un client pour voir les dÃ©tails",
                detail_subtitle_bim: "Comparatif 1er Bimestre (Jan + FÃ©v)",
                detail_subtitle_feb: "Comparatif Mensuel (FÃ©vrier)",
                fact_2025: "Facturation 2025",
                fact_2026: "Facturation 2026",
                col_prod: "Produit",
                col_jan: "Janvier",
                col_feb: "FÃ©vrier",
                col_sum_2025: "Total",
                col_sum_2026: "Total",
                col_growth: "% Crois.",
                group_new: "ðŸŒŸ Nouveaux Clients",
                group_high: "Croissance > 10%",
                group_stable: "Stables (0% - 10%)",
                group_neg: "DÃ©croissance",
                badge_new: "NOUVEAU",
                no_records: "Aucun enregistrement pour cette pÃ©riode",
                no_records_year: "Aucun enregistrement en",
                btn_invoices: "Voir Factures",
                modal_title_prefix: "Factures",
                th_invoice: "# Facture",
                th_amount: "Montant",
                back_list: "Retour Ã  la liste"
            }
        };

        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbzlhL86vAM7niocvLrwBQYT1xdG8Gns5WblTwEp8TAumkUPTVhKmPZSK8QXwzHhP_nd/exec",
            MOCK_DATA: [
                { id: "m1", nombre: "Cliente Ejemplo 1", ventas2025: 100, ventas2026: 200, productos: [], facturas: [] }
            ]
        };

        let state = { allData: [], selectedId: null, searchTerm: "", viewMode: 'february', isDemo: false, lang: 'es' };

        function t(key) { return translations[state.lang][key] || key; }

        window.changeLanguage = (lang) => {
            state.lang = lang;
            document.getElementById('lang-es').classList.toggle('active', lang === 'es');
            document.getElementById('lang-fr').classList.toggle('active', lang === 'fr');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            document.getElementById('search-input').placeholder = t('search_placeholder');
            changeView(state.viewMode);
        };

        const formatCurrency = (val) => {
            if (val === undefined || val === null) return '$0.00';
            return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val);
        };

        const formatPercent = (val) => {
            if (!val || isNaN(val) || !isFinite(val)) return '-';
            const sign = val > 0 ? '+' : '';
            return `${sign}${val.toFixed(1)}%`;
        };

        async function initApp() {
            try {
                const url = `${CONFIG.API_URL}?t=${Date.now()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error("Error de red");
                const text = await response.text();
                if (text.includes("<!DOCTYPE")) throw new Error("Acceso denegado (HTML response)");
                
                state.allData = JSON.parse(text);
                state.isDemo = false;
            } catch (err) {
                console.warn("Modo demo activo:", err);
                state.allData = CONFIG.MOCK_DATA;
                state.isDemo = true;
                document.getElementById('status-bar').classList.remove('hidden');
                document.getElementById('status-text').textContent = "Modo Demo Activado (Verifica conexiÃ³n)";
            } finally {
                document.getElementById('list-loader').classList.add('hidden');
                const userLang = navigator.language || navigator.userLanguage;
                if (userLang.toLowerCase().startsWith('fr')) {
                    changeLanguage('fr');
                } else {
                    changeLanguage('es');
                }
            }
        }

        window.changeView = (mode) => {
            state.viewMode = mode;
            const btnFeb = document.getElementById('tab-february');
            const btnBim = document.getElementById('tab-bimester');
            if (mode === 'february') {
                btnFeb.className = "flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-active touch-manipulation";
                btnBim.className = "flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-inactive touch-manipulation";
            } else {
                btnFeb.className = "flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-inactive touch-manipulation";
                btnBim.className = "flex-1 py-3 md:py-2 px-2 text-[11px] sm:text-xs font-bold rounded-lg transition-all text-center tab-active touch-manipulation";
            }
            document.querySelectorAll('.header-year-2025').forEach(el => el.textContent = mode === 'bimester' ? t('col_total_2025') : t('col_feb_2025'));
            document.querySelectorAll('.header-year-2026').forEach(el => el.textContent = mode === 'bimester' ? t('col_total_2026') : t('col_feb_2026'));
            updateUI();
            if (state.selectedId) {
                const client = state.allData.find(c => c.id === state.selectedId);
                if (client) renderDetail(client);
            }
        };

        function getClientValues(client) {
            if (state.viewMode === 'bimester') {
                return { v25: client.ventas2025, v26: client.ventas2026 };
            } else {
                const v25 = client.productos.reduce((sum, p) => sum + (p.v25_feb || 0), 0);
                const v26 = client.productos.reduce((sum, p) => sum + (p.v26_feb || 0), 0);
                return { v25, v26 };
            }
        }

        function updateUI() {
            const processed = state.allData
                .filter(c => c.nombre.toLowerCase().includes(state.searchTerm.toLowerCase()))
                .map(c => {
                    const vals = getClientValues(c);
                    let growth = 0;
                    let isNew = false;

                    if (vals.v25 > 0) {
                        growth = ((vals.v26 - vals.v25) / vals.v25) * 100;
                    } else if (vals.v26 > 0) {
                        growth = 100;
                        isNew = true;
                    } else if (vals.v25 > 0 && vals.v26 === 0) {
                        growth = -100;
                    }

                    return { ...c, vals, growth, isNew };
                });

            const newClients = processed.filter(c => c.isNew).sort((a,b) => b.vals.v26 - a.vals.v26);
            const highGrowth = processed.filter(c => !c.isNew && c.growth > 10).sort((a,b) => a.nombre.localeCompare(b.nombre));
            const stableGrowth = processed.filter(c => !c.isNew && c.growth >= 0 && c.growth <= 10).sort((a,b) => a.nombre.localeCompare(b.nombre));
            const negativeGrowth = processed.filter(c => !c.isNew && c.growth < 0).sort((a,b) => a.growth - b.growth);

            const container = document.getElementById('clients-list');
            Array.from(container.children).forEach(child => {
                if (child.id !== 'list-loader') container.removeChild(child);
            });

            renderGroup(container, newClients, t('group_new'), "text-purple-700 bg-purple-50 border-purple-100");
            renderGroup(container, highGrowth, t('group_high'), "text-green-700 bg-green-50 border-green-100");
            renderGroup(container, stableGrowth, t('group_stable'), "text-blue-700 bg-blue-50 border-blue-100");
            renderGroup(container, negativeGrowth, t('group_neg'), "text-red-700 bg-red-50 border-red-100");

            document.getElementById('list-footer').textContent = `${processed.length} ${t('footer_listed')}`;
        }

        function renderGroup(container, items, title, classes) {
            if (items.length === 0) return;
            const header = document.createElement('div');
            header.className = `sticky top-0 z-10 px-4 py-1.5 border-y text-[10px] font-bold uppercase tracking-wide flex items-center justify-between backdrop-blur-sm bg-opacity-95 ${classes}`;
            header.innerHTML = `<span>${title}</span><span class="bg-white/50 px-1.5 rounded-full">${items.length}</span>`;
            container.appendChild(header);
            items.forEach(item => {
                const el = document.createElement('div');
                const isSelected = item.id === state.selectedId;
                let baseClass = "grid grid-cols-12 px-4 py-4 md:py-3 border-b border-slate-50 cursor-pointer transition-all duration-200 items-start relative group ";
                if (isSelected) baseClass += "bg-blue-50/60 "; else baseClass += "hover:bg-slate-50 ";
                el.className = baseClass;
                el.onclick = () => { selectClient(item); };
                let badge = '';
                if (item.isNew) {
                    badge = `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] mt-1 font-bold bg-purple-100 text-purple-700 border border-purple-200">âœ¨ ${t('badge_new')}</span>`;
                } else if (item.vals.v25 > 0 || item.vals.v26 > 0) {
                    const color = item.growth >= 0 ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200';
                    const icon = item.growth >= 0 ? 'â–²' : 'â–¼';
                    badge = `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[9px] mt-1 font-medium border ${color}">${icon} ${Math.abs(item.growth).toFixed(1)}%</span>`;
                }
                const activeBorder = isSelected ? '<div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-600 rounded-r"></div>' : '';
                el.innerHTML = `${activeBorder}<div class="col-span-6 pr-2 pl-2"><p class="text-xs font-bold text-wrap ${isSelected ? 'text-blue-700' : 'text-slate-700'}">${item.nombre}</p>${badge}</div><div class="col-span-3 text-right text-[10px] sm:text-xs text-slate-500 font-medium font-mono truncate pt-0.5">${formatCurrency(item.vals.v25)}</div><div class="col-span-3 text-right text-[10px] sm:text-xs font-bold font-mono truncate pt-0.5 ${item.vals.v26 >= item.vals.v25 ? 'text-slate-800' : 'text-red-600'}">${formatCurrency(item.vals.v26)}</div>`;
                container.appendChild(el);
            });
        }

        function selectClient(item) {
            state.selectedId = item.id;
            updateUI(); // Refrescar lista para selecciÃ³n visual
            renderDetail(item);
            
            // MOSTRAR DETALLE EN MÃ“VIL
            if (window.innerWidth < 768) {
                document.getElementById('left-panel').classList.add('hidden');
                document.getElementById('detail-panel').classList.remove('hidden', 'md:flex');
                document.getElementById('detail-panel').classList.add('flex');
            }
        }

        window.backToMobileList = () => {
            // OCULTAR DETALLE Y MOSTRAR LISTA
            document.getElementById('left-panel').classList.remove('hidden');
            document.getElementById('detail-panel').classList.add('hidden');
            document.getElementById('detail-panel').classList.remove('flex');
            // Limpiar selecciÃ³n para feedback visual
            state.selectedId = null;
            updateUI();
        }

        function renderDetail(client) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('detail-content').classList.remove('hidden');
            const vals = getClientValues(client);
            document.getElementById('detail-title').textContent = client.nombre;
            const subText = state.viewMode === 'bimester' ? t('detail_subtitle_bim') : t('detail_subtitle_feb');
            document.getElementById('detail-subtitle').textContent = subText;
            document.getElementById('total-2025').textContent = `Total: ${formatCurrency(vals.v25)}`;
            document.getElementById('total-2026').textContent = `Total: ${formatCurrency(vals.v26)}`;
            
            // En mÃ³vil, podemos ocultar columnas de Ene/Feb si falta espacio, pero en desktop las mostramos
            // Usamos clases CSS 'hidden md:table-cell' en HTML
            
            renderDetailTable('tbody-2025', client.productos, 2025);
            renderDetailTable('tbody-2026', client.productos, 2026);
        }

        function renderDetailTable(tbodyId, products, year) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            const items = products.map(p => {
                const prefix = year === 2026 ? 'v26' : 'v25';
                const ene = p[`${prefix}_ene`] || 0;
                const feb = p[`${prefix}_feb`] || 0;
                const total = state.viewMode === 'bimester' ? (p[`${prefix}_total`] || (ene+feb)) : feb;
                return { ...p, ene, feb, total };
            }).filter(p => p.total > 0).sort((a,b) => b.total - a.total);

            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400 italic">${t('no_records_year')} ${year}</td></tr>`;
                return;
            }

            items.forEach(p => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 group border-b border-slate-50 last:border-0";
                let growthCell = '';
                if (year === 2026) {
                    const p25 = getProductData(p, 2025);
                    const base25 = state.viewMode === 'bimester' ? p25.total : p25.feb;
                    let badge = '<span class="text-slate-300 text-xs">-</span>';
                    if (base25 > 0) {
                        const pct = ((p.total - base25) / base25) * 100;
                        const color = pct >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                        const icon = pct >= 0 ? 'â–²' : 'â–¼';
                        badge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs ${color} font-bold">${icon} ${Math.abs(pct).toFixed(1)}%</span>`;
                    } else if (p.total > 0) {
                        badge = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-purple-100 text-purple-700 font-bold">${t('badge_new')}</span>`;
                    }
                    growthCell = `<td class="px-4 md:px-6 py-3 text-right">${badge}</td>`;
                } else {
                    growthCell = `<td class="px-4 md:px-6 py-3"></td>`;
                }
                tr.innerHTML = `<td class="px-4 md:px-6 py-3 font-medium text-slate-700 break-words w-5/12 text-xs sm:text-sm">${p.nombre}</td><td class="px-4 md:px-6 py-3 text-right font-mono text-slate-500 text-xs hidden md:table-cell">${formatCurrency(p.ene)}</td><td class="px-4 md:px-6 py-3 text-right font-mono text-slate-500 text-xs hidden md:table-cell">${formatCurrency(p.feb)}</td><td class="px-4 md:px-6 py-3 text-right font-mono font-bold text-slate-800 bg-slate-50/50 text-xs sm:text-sm">${formatCurrency(p.total)}</td>${growthCell}`;
                tbody.appendChild(tr);
            });
        }

        function getProductData(rawProd, year) {
            const y = year === 2026 ? 'v26' : 'v25';
            return { ene: rawProd[`${y}_ene`] || 0, feb: rawProd[`${y}_feb`] || 0, total: rawProd[`${y}_total`] || 0 };
        }

        // --- LÃ“GICA DE MODAL DE FACTURAS ---
        window.openInvoiceModal = (year) => {
            const client = state.allData.find(c => c.id === state.selectedId);
            if (!client || !client.facturas) return;

            const modal = document.getElementById('invoice-modal');
            const tbody = document.getElementById('modal-tbody');
            tbody.innerHTML = '';

            const filteredInvoices = client.facturas.filter(f => {
                if (f.anio !== year) return false;
                if (state.viewMode === 'february' && f.mes !== 1) return false;
                return true;
            });

            document.getElementById('modal-title').textContent = `${t('modal_title_prefix')} ${year}`;
            document.getElementById('modal-subtitle').textContent = state.viewMode === 'bimester' ? t('tab_bimester') : t('tab_feb');

            if (filteredInvoices.length === 0) {
                tbody.innerHTML = `<tr><td colspan="2" class="px-6 py-8 text-center text-slate-400 italic">${t('no_records')}</td></tr>`;
                document.getElementById('modal-total').textContent = formatCurrency(0);
                document.getElementById('modal-count').textContent = "0 facturas";
            } else {
                let total = 0;
                filteredInvoices.sort((a,b) => b.monto - a.monto).forEach(f => {
                    total += f.monto;
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50 border-b border-slate-50";
                    tr.innerHTML = `
                        <td class="px-6 py-3 font-mono text-xs text-blue-600 font-bold">${f.numero}</td>
                        <td class="px-6 py-3 text-right font-mono text-slate-700">${formatCurrency(f.monto)}</td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('modal-total').textContent = formatCurrency(total);
                document.getElementById('modal-count').textContent = `${filteredInvoices.length} facturas`;
            }

            modal.classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('invoice-modal').classList.add('hidden');
        };

        document.getElementById('invoice-modal').addEventListener('click', (e) => {
            if (e.target.id === 'invoice-modal') closeModal();
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
            state.searchTerm = e.target.value;
            updateUI();
        });

        initApp();
    </script>
</body>
</html>
